
<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Good Practices to Use a KafkaProducer</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.0/css/bootstrap.min.css" integrity="sha384-SI27wrMjH3ZZ89r4o+fGIJtnzkAnFs3E4qz9DIYioCQ5l9Rd/7UAa8DHcaL8jkWt" crossorigin="anonymous">
    <style>
      pre { background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; padding: 0.6em 1em; }
      h1,h2 { margin-top: 1em; }
      div.navbar { padding: 8px 0; }
      div.toc { float: right; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 id="good-practices-to-use-a-kafkaproducer"><a class="toclink" href="#good-practices-to-use-a-kafkaproducer">Good Practices to Use a KafkaProducer</a></h1>
<p>If we want to achieve high performance/availability, here're some rules of thumb.</p>
<h2 id="avoid-using-syncsend-for-better-throughput"><a class="toclink" href="#avoid-using-syncsend-for-better-throughput">Avoid using <code>syncSend</code> for better throughput</a></h2>
<p>You should never call <code>syncSend</code> if you want to get a high throughput. The <code>syncSend</code> is a synchronous operation, and would not go on until the <code>acks</code> are received.</p>
<h2 id="the-messagemaxbytes-must-be-consistent-with-kafka-servers-setting"><a class="toclink" href="#the-messagemaxbytes-must-be-consistent-with-kafka-servers-setting">The <code>message.max.bytes</code> must be consistent with Kafka servers' setting</a></h2>
<ul>
<li>
<p>Default value: 1000,000</p>
</li>
<li>
<p>The default setting for brokers is <code>message.max.bytes = 1000012</code>, and do MAKE SURE the client side setting no larger than it. Otherwise, it might construct a MessageSet which would be rejected (error: INVALID_MESSAGE_SIZE) by brokers.</p>
</li>
</ul>
<h2 id="calculate-batchnummessages-with-the-average-message-size"><a class="toclink" href="#calculate-batchnummessages-with-the-average-message-size">Calculate <code>batch.num.messages</code> with the average message size</a></h2>
<ul>
<li>
<p>Default value: 10,000</p>
</li>
<li>
<p>It defines the maximum number of messages batched in one MessageSet.</p>
<p>Normally, larger value, better performance. However, since the size of MessageSet is limited by <code>message.max.bytes</code>, a too large value would not help any more.</p>
<p>E.g, with the default <code>message.max.bytes=1000000</code> and <code>batch.num.messages=10000</code> settings, you could get the best performance while the average message size is larger than 100 bytes.</p>
<p>However, if the average message size is small, you have to enlarge it (to <code>message.max.bytes/average_message_size</code> at least).</p>
</li>
</ul>
<h2 id="choose-acks-wisely"><a class="toclink" href="#choose-acks-wisely">Choose <code>acks</code> wisely</a></h2>
<ul>
<li>
<p>The acks parameter controls how many partition replicas must receive the record before the producer can consider the write successful.</p>
<ul>
<li>
<p><code>acks=0</code>, the producer will not wait for a reply from the broker before assuming the message was sent successfully.</p>
</li>
<li>
<p><code>acks=1</code>, the producer will receive a success response from the broker the moment the leader replica received the message.</p>
</li>
<li>
<p><code>acks=all</code>, the producer will receive a success response from the broker once all in-sync replicas received the message.</p>
</li>
<li>
<p>Note: if "ack=all", please make sure the topic's replication factor is larger than 1.</p>
</li>
</ul>
</li>
<li>
<p>The <code>acks=all</code> setting will highly impact the throughput &amp; latency, and it would be obvious if the traffic latency between kafka brokers is high. But it's mandatory if we want to achieve high availability.</p>
</li>
</ul>
<h2 id="how-could-a-message-miss-after-send"><a class="toclink" href="#how-could-a-message-miss-after-send">How could a message miss after send?</a></h2>
<ul>
<li>
<p>The message might even not have been received by the partition leader! (with <code>acks=0</code>)</p>
</li>
<li>
<p>Once the message received by the partition leader, the leader crashed just after responding to the producer, but has no chance to synchronize the message to other replicas. (with <code>acks=1</code>)</p>
</li>
<li>
<p>Once the message received by the partition leader, the leader crashed just after responding to the producer, but with no in-sync replica to synchronize for the message. (with <code>acks=all</code>, while brokers are with <code>min.insync.replicas=1</code>)</p>
</li>
</ul>
      <hr/>
      <footer class="text-center text-muted">
        Generated: 2022. 03. 15
      </footer>
      <hr/>
    </div>
  </body>
</html>